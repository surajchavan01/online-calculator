# app/routes/report_route.py
from fastapi import APIRouter, HTTPException
from fastapi.responses import FileResponse, JSONResponse
from schema import ReportFilters
from services.report_service import run_report
from utils.excel_export import to_excel
import os

router = APIRouter(prefix="/api/report", tags=["report"])

@router.post("/", response_model=dict)
def get_report(filters: ReportFilters):
    sql, rows = run_report(filters)
    return {"query": sql, "data": rows}

@router.post("/export")
def export_report(filters: ReportFilters):
    sql, rows = run_report(filters)
    filename = to_excel(rows, "report.xlsx")
    if not os.path.exists(filename):
        raise HTTPException(status_code=500, detail="Export failed")
    return FileResponse(path=filename, media_type='application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', filename=filename)
